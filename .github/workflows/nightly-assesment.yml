name: Kubebench Scan
on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
jobs:
  kube-bench:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Install MicroK8S
        run: |
          sudo snap install microk8s --classic --channel=1.23/stable
          sudo microk8s enable dns storage rbac ingress metallb
          sudo microk8s status --wait-ready
          sudo microk8s kubectl rollout status deployment/hostpath-provisioner -n kube-system
          sudo microk8s enable registry
          sudo microk8s status --wait-ready
          sudo microk8s kubectl rollout status deployment/registry -n container-registry
          mkdir -p ~/.kube
          sudo microk8s config > ~/.kube/config
      - name: Kubebench scan
        run: |
          docker run --pid=host -v /etc:/etc:ro -v /var:/var:ro -t aquasec/kube-bench:latest --version 1.23
      